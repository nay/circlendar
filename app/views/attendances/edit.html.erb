<div class="w-full max-w-2xl mx-auto">
  <div class="mb-4">
    <%= link_to "← ダッシュボードに戻る", dashboard_path, class: "text-blue-600 hover:text-blue-700 text-sm" %>
  </div>
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900"><%= @event.headline %></h1>
    <p class="mt-2 text-gray-600">
      <%= @event.schedule %>
    </p>
  </div>

  <%= form_with(model: @attendance, url: event_attendance_path(@event), method: :patch, class: "bg-white shadow sm:rounded-lg") do |form| %>
    <div class="px-4 py-5 sm:p-6 space-y-6">
      <% if @event.venue.announcement_detail.present? %>
        <div class="text-sm text-gray-700"><%= format_with_links(@event.venue.announcement_detail) %></div>
      <% end %>

      <!-- ステータス -->
      <div>
        <%= form.label :status, "練習会への参加", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <div class="grid grid-cols-3 gap-3" data-controller="radio-buttons">
          <% Attendance.statuses.keys.each do |status| %>
            <label class="flex items-center justify-center px-4 py-3 border-2 rounded-lg cursor-pointer <%= @attendance.status == status ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white' %>" data-radio-buttons-target="option">
              <%= form.radio_button :status, status, class: "sr-only", data: { action: "change->radio-buttons#select" } %>
              <span class="text-sm font-medium text-gray-900">
                <%= I18n.t("activerecord.attributes.attendance.statuses.#{status}") %>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- 到着時刻 -->
      <div>
        <%= form.label :arrival_time, "到着予定時刻", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.time_field :arrival_time, class: "block w-full rounded-md border border-gray-400 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base p-3" %>
      </div>

      <!-- 退出時刻 -->
      <div>
        <%= form.label :departure_time, "退出予定時刻", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.time_field :departure_time, class: "block w-full rounded-md border border-gray-400 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base p-3" %>
      </div>

      <!-- アフター -->
      <div>
        <%= form.label :after_party, "アフターへの参加", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <div class="grid grid-cols-3 gap-3" data-controller="radio-buttons">
          <% Attendance.after_parties.keys.each do |after_party| %>
            <label class="flex items-center justify-center px-4 py-3 border-2 rounded-lg cursor-pointer <%= @attendance.after_party == after_party ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white' %>" data-radio-buttons-target="option">
              <%= form.radio_button :after_party, after_party, class: "sr-only", data: { action: "change->radio-buttons#select" } %>
              <span class="text-sm font-medium text-gray-900">
                <%= I18n.t("activerecord.attributes.attendance.after_parties.#{after_party}") %>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- メッセージ -->
      <div>
        <%= form.label :message, "メッセージ", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.text_area :message, rows: 4, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3", placeholder: "連絡事項があればこちらへどうぞ" %>
      </div>
    </div>

    <div class="px-4 py-3 bg-gray-50 text-right sm:px-6 space-x-3 sm:rounded-b-lg">
      <%= link_to "キャンセル", dashboard_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
      <%= form.submit "保存", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer" %>
    </div>
  <% end %>

  <!-- 参加者一覧 -->
  <div class="mt-8">
    <h2 class="text-lg font-medium text-gray-900 mb-4">参加者（<%= @attendees.count %>名）</h2>
    <% if @attendees.any? %>
      <div class="flex flex-wrap gap-2">
        <% @attendees.each do |attendance| %>
          <% member = attendance.player %>
          <div class="relative" data-controller="member-popup"
               data-member-popup-name-value="<%= member.name %>"
               data-member-popup-organization-value="<%= member.organization_name %>"
               data-member-popup-rank-value="<%= member.formatted_rank %>"
               data-member-popup-description-value="<%= member.description %>">
            <button type="button"
                    data-action="click->member-popup#show"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
              <%= member.name %>
            </button>
            <div data-member-popup-target="popup"
                 class="hidden absolute z-50 left-0 mt-2 w-64 p-4 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5">
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-sm">まだ参加者はいません</p>
    <% end %>
  </div>

  <!-- メッセージ一覧 -->
  <% attendees_with_message = @attendees.select { |a| a.message.present? } %>
  <% if attendees_with_message.any? %>
    <div class="mt-8">
      <h2 class="text-lg font-medium text-gray-900 mb-4">メッセージ</h2>
      <div class="space-y-4">
        <% attendees_with_message.each do |attendance| %>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="font-medium text-gray-900 mb-1"><%= attendance.player.name %></div>
            <div class="text-sm text-gray-600 whitespace-pre-wrap"><%= attendance.message %></div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
