<div class="w-full max-w-2xl mx-auto">
  <div class="mb-4">
    <%= link_to "‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã", dashboard_path, class: "text-blue-600 hover:text-blue-700 text-sm" %>
  </div>
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900"><%= @event.headline %></h1>
    <p class="mt-2 text-gray-600">
      <%= @event.schedule %>
    </p>
  </div>

  <%= form_with(model: @attendance, url: event_attendance_path(@event), method: :patch, class: "bg-white shadow sm:rounded-lg") do |form| %>
    <div class="px-4 py-5 sm:p-6 space-y-6">
      <% if @event.venue.announcement_detail.present? %>
        <div class="text-sm text-gray-700"><%= format_with_links(@event.venue.announcement_detail) %></div>
      <% end %>

      <!-- „Çπ„ÉÜ„Éº„Çø„Çπ -->
      <div>
        <%= form.label :status, "Á∑¥Áøí‰ºö„Å∏„ÅÆÂèÇÂä†", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <div class="grid grid-cols-3 gap-3" data-controller="radio-buttons">
          <% Attendance.statuses.keys.each do |status| %>
            <label class="flex items-center justify-center px-4 py-3 border-2 rounded-lg cursor-pointer <%= @attendance.status == status ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white' %>" data-radio-buttons-target="option">
              <%= form.radio_button :status, status, class: "sr-only", data: { action: "change->radio-buttons#select" } %>
              <span class="text-sm font-medium text-gray-900">
                <%= I18n.t("activerecord.attributes.attendance.statuses.#{status}") %>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- „Ç¢„Éï„Çø„Éº -->
      <div>
        <%= form.label :after_party, "„Ç¢„Éï„Çø„Éº„Å∏„ÅÆÂèÇÂä†", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <div class="grid grid-cols-3 gap-3" data-controller="radio-buttons">
          <% Attendance.after_parties.keys.each do |after_party| %>
            <label class="flex items-center justify-center px-4 py-3 border-2 rounded-lg cursor-pointer <%= @attendance.after_party == after_party ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white' %>" data-radio-buttons-target="option">
              <%= form.radio_button :after_party, after_party, class: "sr-only", data: { action: "change->radio-buttons#select" } %>
              <span class="text-sm font-medium text-gray-900">
                <%= I18n.t("activerecord.attributes.attendance.after_parties.#{after_party}") %>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- „É°„ÉÉ„Çª„Éº„Ç∏ -->
      <div>
        <%= form.label :message, "„É°„ÉÉ„Çª„Éº„Ç∏", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.text_area :message, rows: 4, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3", placeholder: "ÈÄ£Áµ°‰∫ãÈ†Ö„Åå„ÅÇ„Çå„Å∞„Åì„Å°„Çâ„Å∏„Å©„ÅÜ„Åû" %>
      </div>
    </div>

    <div class="px-4 py-3 bg-gray-50 text-right sm:px-6 space-x-3 sm:rounded-b-lg">
      <%= link_to "„Ç≠„É£„É≥„Çª„É´", dashboard_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
      <%= form.submit "‰øùÂ≠ò", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer" %>
    </div>
  <% end %>

  <!-- ÂèÇÂä†ËÄÖ‰∏ÄË¶ß -->
  <div class="mt-8">
    <%
      practice_attendees = @attendees.select { |a| a.status == "attending" }
      after_only_attendees = @attendees.select { |a| a.status != "attending" && a.after_party == "attending" }
    %>
    <h2 class="text-lg font-medium text-gray-900 mb-4">ÂèÇÂä†ËÄÖÔºà<%= practice_attendees.count %>ÂêçÔºâ<% if after_only_attendees.any? %> + „Ç¢„Éï„Çø„Éº„ÅÆ„ÅøÔºà<%= after_only_attendees.count %>ÂêçÔºâ<% end %></h2>
    <% if @attendees.any? %>
      <div class="flex flex-wrap gap-2">
        <% @attendees.each do |attendance| %>
          <% member = attendance.player %>
          <%
            is_practice = attendance.status == "attending"
            is_after = attendance.after_party == "attending"
            # Á∑¥Áøí„ÅÆ„Åø: ÈÄöÂ∏∏„Çπ„Çø„Ç§„É´, Á∑¥Áøí+„Ç¢„Éï„Çø„Éº: ÈÄöÂ∏∏+„Éì„Éº„É´, „Ç¢„Éï„Çø„Éº„ÅÆ„Åø: ÁÇπÁ∑ö+„Éì„Éº„É´
            border_class = is_practice ? "border-solid" : "border-dashed"
          %>
          <div class="relative" data-controller="member-popup"
               data-member-popup-name-value="<%= member.name %>"
               data-member-popup-organization-value="<%= member.organization_name %>"
               data-member-popup-rank-value="<%= member.formatted_rank %>"
               data-member-popup-description-value="<%= member.description %>">
            <button type="button"
                    data-action="click->member-popup#show"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors border-2 border-blue-300 <%= border_class %>">
              <%= member.name %><% if is_after %><span class="ml-1">üç∫</span><% end %>
            </button>
            <div data-member-popup-target="popup"
                 class="hidden absolute z-50 left-0 mt-2 w-64 p-4 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5">
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-sm">„Åæ„Å†ÂèÇÂä†ËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</p>
    <% end %>
  </div>

  <!-- „É°„ÉÉ„Çª„Éº„Ç∏‰∏ÄË¶ß -->
  <% attendees_with_message = @attendees.select { |a| a.message.present? } %>
  <% if attendees_with_message.any? %>
    <div class="mt-8">
      <h2 class="text-lg font-medium text-gray-900 mb-4">„É°„ÉÉ„Çª„Éº„Ç∏</h2>
      <div class="space-y-4">
        <% attendees_with_message.each do |attendance| %>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="font-medium text-gray-900 mb-1"><%= attendance.player.name %></div>
            <div class="text-sm text-gray-600 whitespace-pre-wrap pl-3"><%= attendance.message %></div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
